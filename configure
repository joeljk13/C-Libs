#!/bin/sh

PARAMS="-std=c99"
DEBUG=true
OPTIMIZATION="-O0"
WARNINGS=""
ERRS="-pedantic-errors"
DEFS=""
EXEC="test"
LINKS="jemalloc"
SRCDIR="src"
TESTDIR="tests"
CC="clang"
MAKEFILE="Makefile"
EXT="c"
MAIN="int main(int c,char**v){int ${EXEC}_main(int,char**);return \
    ${EXEC}_main(c,v);}"

SRCS=$(find -wholename "./$SRCDIR/*.$EXT" | tr "\n" " ")
TESTS=$(find -wholename "./$TESTDIR/*.$EXT" | tr "\n" " ")

CPARAMS="$PARAMS $WARNINGS $ERRS"

if $DEBUG
then
    CPARAMS="$CPARAMS -g -O0 -DDEBUG"
else
    CPARAMS="$CPARAMS $OPTIMIZATION -DNDEBUG"
fi

for DEF in $DEFS
do
    CPARAMS="$CPARAMS -D$DEF"
done

LPARAMS=""

LLINKS=""

if ! $DEBUG
then
    LPARAMS="$LPARAMS $OPTIMIZATION"
fi

for LINK in $LINKS
do
    LLINKS="$LLINKS -l$LINK"
done

printf "
SHELL = /bin/sh
SRCS = %s
SRCOBJS = \$(SRCS:.$EXT=.o)
TESTS = %s
TESTOBJS = \$(TESTS:.$EXT=.o)
CPARAMS = %s
LPARAMS = %s
LINKS = $LLINKS
$EXEC: \$(SRCOBJS) $SRCDIR/$EXEC-main.o
\t$CC -o \$@ \$(LPARAMS) \$^ \$(LINKS)
$SRCDIR/$EXEC-main.o:
\techo '%s' | $CC -c -o \$@ -x $EXT \$(CPARAMS) -
" "$SRCS" "$TESTS" "$CPARAMS" "$LPARAMS" "$MAIN" > $MAKEFILE

for SRC in $SRCS
do
    printf "$SRCDIR/%s\n\t$CC -c -o \$@ \$(CPARAMS) \$<\n" "$($CC -MM $SRC)" >> \
        $MAKEFILE
done

printf "
.PHONY: check
check: \$(TESTOBJS) ;
" >> $MAKEFILE

for TEST in $TESTS
do
    # the rm check \$@ could use -f, but it shouldn't be necessary
    printf "$TESTDIR/%s\n\t$CC -c -o \$@ \$(CPARAMS) \$< \
        \n\t$CC -o check \$(LPARAMS) \$@ \$(SRCOBJS) \$(LINKS) \
        \n\ttput setaf 1; if ! ./check; then echo 'Check failed!'; tput sgr 0; rm check; exit 1; else tput sgr 0; fi \
        \n\ttput setaf 2; echo 'Check succeeded!'; tput sgr 0 \
        \n\trm check \$@" \
        "$($CC -MM $TEST)" >> $MAKEFILE
done

printf "
.PHONY: clean
clean:
\trm -rf %s *.[ios] \$(SRCOBJS) \$(TESTOBJS) $SRCDIR/$EXEC-main.o
" "$EXEC" >> $MAKEFILE
