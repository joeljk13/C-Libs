#!/bin/sh

PARAMS="-std=c99"
DEBUG=true
OPTIMIZATION="-O"
WARNINGS=""
ERRS="-pedantic-errors"
DEFS=""
EXEC="test"
LINKS=""
SRCDIR="src"
TESTDIR="tests"
CC="gcc"
MAKEFILE="Makefile"
EXT="c"

SRCS=$(find -wholename "./$SRCDIR/*.$EXT" | tr "\n" " ")
TESTS=$(find -wholename "./$TESTDIR/*.$EXT" | tr "\n" " ")

# temp
SRCS="./src/alloc.c ./src/main.c"

CPARAMS="$PARAMS $WARNINGS $ERRS"

if $DEBUG
then
    CPARAMS="$CPARAMS -g -Og -DDEBUG"
else
    CPARAMS="$CPARAMS $OPTIMIZATION -DNDEBUG"
fi

for DEF in $DEFS
do
    CPARAMS="$CPARAMS -D$DEF"
done

LPARAMS=""

LLINKS=""

if ! $DEBUG
then
    LPARAMS="$LPARAMS $OPTIMIZATION"
fi

for LINK in $LINKS
do
    LPARAMS="$LPARAMS -l$LINK"
done

printf "
SHELL = /bin/sh
SRCS = %s
SRCOBJS = \$(SRCS:.$EXT=.o)
TESTS = %s
TESTOBJS = \$(TESTS:$EXT=.o)
CPARAMS = %s
LPARAMS = %s
LINKS = $LLINKS
%s: \$(SRCOBJS)
\t$CC -o \$@ \$(LPARAMS) \$^ \$(LINKS)
" "$SRCS" "$TESTS" "$CPARAMS" "$LPARAMS" "$EXEC" > $MAKEFILE

for SRC in $SRCS
do
    printf "$SRCDIR/%s\n\t$CC -c -o \$@ \$(CPARAMS) \$<\n" "$($CC -MM $SRC)" >> \
        $MAKEFILE
done

printf "
.PHONY: check
check: \$(TESTOBJS) ;
" >> $MAKEFILE

for TEST in $TESTS
do
    # the rm check \$@ could use -f, but it shouldn't be necessary
    printf "$TESTDIR/%s\n\t$CC -c -o \$@ \$(CPARAMS) \$< \
        \n\t$CC -o check \$(LPARAMS) \$@ %s \$(LINKS) \
        \n\tif ! ./check; then echo 'check failed'; fi \
        \n\trm check \$@" \
        "$($CC -MM $TEST)" \
        "$(printf "%s" "$TEST" | sed -e "s/$TESTDIR/$SRCDIR/" | \
            sed -e "s/$EXT\$/o/")" >> $MAKEFILE
done

printf "
.PHONY: clean
clean:
\trm -rf %s \$(SRCOBJS) \$(TESTOBJS)
" "$EXEC" >> $MAKEFILE
