#!/bin/sh

PARAMS="-std=c99"
DEBUG=true
OPTIMIZATION="-O0"
WARNINGS="-Wno-unused-value -Wno-attributes"
ERRS="-pedantic-errors"
DEFS=""
TESTDEFS="COLOR_RESET='\"$(tput sgr 0)\"' \
    COLOR_RED='\"$(tput setaf 1)\"' \
    COLOR_GREEN='\"$(tput setaf 2)\"' \
    COLOR_YELLOW='\"$(tput setaf 3)\"'"
EXEC="test"
LINKS="jemalloc"
SRCDIR="src"
TESTDIR="tests"
CC="clang"
MAKEFILE="Makefile"
EXT="c"
MAIN="int main(int c,char**v){int ${EXEC}_main(int,char**);return \
    ${EXEC}_main(c,v);}"

SRCS=$(find -wholename "./$SRCDIR/*.$EXT" | tr "\n" " ")
TESTS=$(find -wholename "./$TESTDIR/*.$EXT" | tr "\n" " ")

# tmp
SRCS="./src/alloc.c ./src/main.c ./src/vec.c ./src/ptrvec.c ./src/str.c"

CPARAMS="$PARAMS $WARNINGS $ERRS"

if $DEBUG
then
    CPARAMS="$CPARAMS -g -O0 -DDEBUG"
    LPARAMS="$LPARAMS -g"
else
    CPARAMS="$CPARAMS $OPTIMIZATION -DNDEBUG"
fi

for DEF in $DEFS
do
    CPARAMS="$CPARAMS -D$DEF"
done

LPARAMS=""

LLINKS=""

if ! $DEBUG
then
    LPARAMS="$LPARAMS $OPTIMIZATION"
fi

for LINK in $LINKS
do
    LLINKS="$LLINKS -l$LINK"
done

TPARAMS="$CPARAMS"

for TESTDEF in $TESTDEFS
do
    TPARAMS="$TPARAMS -D$TESTDEF"
done

printf "
SHELL = /bin/sh
SRCS = %s
SRCOBJS = \$(SRCS:.$EXT=.o)
TESTS = %s
TESTOBJS = \$(TESTS:.$EXT=.o)
CPARAMS = %s
LPARAMS = %s
LINKS = $LLINKS
TPARAMS = %s

$EXEC: \$(SRCOBJS) $SRCDIR/$EXEC-main.o
\t$CC -o \$@ \$(LPARAMS) \$^ \$(LINKS)
$SRCDIR/$EXEC-main.o:
\techo '%s' | $CC -c -o \$@ -x $EXT \$(CPARAMS) -
" "$SRCS" "$TESTS" "$CPARAMS" "$LPARAMS" "$TPARAMS" "$MAIN" > $MAKEFILE

for SRC in $SRCS
do
    printf "$SRCDIR/%s\n\t$CC -c -o \$@ \$(CPARAMS) \$<\n" "$($CC -MM $SRC)" >> \
        $MAKEFILE
done

printf "
.PHONY: check
check: \$(TESTOBJS) ;
" >> $MAKEFILE

for TEST in $TESTS
do
    # the rm check \$@ could use -f, but it shouldn't be necessary
    printf "$TESTDIR/%s\n\t@$CC -c -o \$@ \$(TPARAMS) \$< \
        \n\t$CC -o check \$(LPARAMS) \$@ \$(SRCOBJS) \$(LINKS) \
        \n\t@if ! ./check; then echo; tput setaf 1; echo 'Check failed!'; \
            tput sgr 0; exit 1; fi \
        \n\t@echo \
        \n\t@tput setaf 2 \
        \n\t@echo 'Check succeeded!' \
        \n\t@echo \
        \n\t@tput sgr 0 \
        \n\t@rm check \$@\n\n" \
        "$($CC -MM $TEST)" >> $MAKEFILE
done

printf "\n
.PHONY: clean
clean:
\trm -rf %s *.[ios] \$(SRCOBJS) \$(TESTOBJS) $SRCDIR/$EXEC-main.o check
" "$EXEC" >> $MAKEFILE
